<!-- formularios.component.html -->
<div class="formularios-container">
  <!-- Header mejorado -->
  <div class="page-header">
    <div class="page-title">
      <i-lucide [img]="BookIcon" class="lucide-icon"></i-lucide>
      <div>
        <h1>Gestión de Formularios</h1>
        <p class="page-subtitle">
          Administra y configura los formularios del sistema
        </p>
      </div>
    </div>
    <div class="header-actions">
      <button
        class="create-button"
        (click)="abrirModalCrear()"
        [attr.aria-label]="'Crear nuevo formulario'"
      >
        <i-lucide [img]="PlusIcon" class="lucide-icon"></i-lucide>
        Nuevo Formulario
      </button>
    </div>
  </div>

  <!-- Controles de filtro -->
  <div class="filter-controls">
    <div class="search-container">
      <i-lucide [img]="SearchIcon" class="search-icon lucide-icon"></i-lucide>
      <input
        type="text"
        class="search-input"
        placeholder="Buscar formularios por nombre o descripción..."
        [(ngModel)]="filtroTexto"
        (input)="filtrarFormularios()"
        [attr.aria-label]="'Buscar formularios'"
      />
    </div>
    <button
      class="filter-button"
      (click)="toggleFiltros()"
      [attr.aria-label]="'Mostrar filtros avanzados'"
    >
      <i-lucide [img]="FilterIcon" class="lucide-icon"></i-lucide>
      Filtros
    </button>
  </div>

  <!-- Loading -->
  <div *ngIf="cargando" class="loading-container">
    <i-lucide [img]="LoaderIcon" class="loading-spinner lucide-icon"></i-lucide>
    <p class="loading-text">Cargando formularios...</p>
  </div>

  <!-- Contenido principal -->
  <div *ngIf="!cargando">
    <!-- Estado vacío -->
    <div
      *ngIf="formulariosFiltered.length === 0 && !filtroTexto"
      class="empty-state"
    >
      <i-lucide [img]="FileTextIcon" class="empty-icon lucide-icon"></i-lucide>
      <h3 class="empty-title">No hay formularios</h3>
      <p class="empty-description">
        Comienza creando tu primer formulario para gestionar la información de
        tus documentos.
      </p>
      <button class="create-button" (click)="abrirModalCrear()">
        <i-lucide [img]="PlusIcon" class="lucide-icon"></i-lucide>
        Crear Primer Formulario
      </button>
    </div>

    <!-- Sin resultados de búsqueda -->
    <div
      *ngIf="formulariosFiltered.length === 0 && filtroTexto"
      class="empty-state"
    >
      <i-lucide [img]="SearchIcon" class="empty-icon lucide-icon"></i-lucide>
      <h3 class="empty-title">Sin resultados</h3>
      <p class="empty-description">
        No se encontraron formularios que coincidan con "{{ filtroTexto }}".
      </p>
      <button class="filter-button" (click)="limpiarFiltros()">
        <i-lucide [img]="XIcon" class="lucide-icon"></i-lucide>
        Limpiar Búsqueda
      </button>
    </div>

    <!-- Tabla de formularios -->
    <div *ngIf="formulariosFiltered.length > 0" class="table-container">
      <div class="table-header">
        <h3 class="table-title">
          <i-lucide [img]="ListIcon" class="lucide-icon"></i-lucide>
          Lista de Formularios
        </h3>
        <span class="table-info">
          {{ formulariosFiltered.length }} de
          {{ formularios.length }} formularios
        </span>
      </div>

      <table class="formularios-table">
        <thead>
          <tr>
            <th class="id-column">ID</th>
            <th class="nombre-column">Nombre</th>
            <th class="descripcion-column">Descripción</th>
            <th class="fecha-column">Fecha Creación</th>
            <th class="tipo-column">Tipo Documento</th>
            <th class="creador-column">Creado Por</th>
            <th class="acciones-column">Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr
            *ngFor="
              let formulario of formulariosFiltered;
              trackBy: trackByFormulario
            "
          >
            <td class="id-column">
              <span class="id-badge">#{{ formulario.id }}</span>
            </td>
            <td class="nombre-column">
              <strong>{{ formulario.nombre }}</strong>
            </td>
            <td class="descripcion-column">
              <span [title]="formulario.descripcion">
                {{ formulario.descripcion | slice : 0 : 100 }}
                <span *ngIf="formulario.descripcion.length > 100">...</span>
              </span>
            </td>
            <td class="fecha-column">
              <div class="fecha-badge">
                <i-lucide [img]="CalendarIcon" class="lucide-icon"></i-lucide>
                {{ formatearFecha(formulario.fecha_creacion) }}
              </div>
            </td>
            <td class="tipo-column">
              <span class="tipo-badge">
                <i-lucide [img]="FileTextIcon" class="lucide-icon"></i-lucide>
                Tipo {{ formulario.tipo_documento }}
              </span>
            </td>
            <td class="creador-column">
              <div class="creador-badge">
                <i-lucide [img]="UserIcon" class="lucide-icon"></i-lucide>
                Usuario {{ formulario.creado_por }}
              </div>
            </td>
            <td class="acciones-column">
              <div class="action-buttons">
                <button
                  class="action-button view"
                  (click)="verCamposFormulario(formulario.id!)"
                  [attr.aria-label]="
                    'Ver campos del formulario ' + formulario.nombre
                  "
                  title="Ver Campos"
                >
                  <i-lucide [img]="EyeIcon" class="lucide-icon"></i-lucide>
                </button>
                <button
                  class="action-button edit"
                  (click)="abrirModalEditar(formulario)"
                  [attr.aria-label]="'Editar formulario ' + formulario.nombre"
                  title="Editar"
                >
                  <i-lucide [img]="EditIcon" class="lucide-icon"></i-lucide>
                </button>
                <button
                  class="action-button delete"
                  (click)="confirmarEliminar(formulario)"
                  [attr.aria-label]="'Eliminar formulario ' + formulario.nombre"
                  title="Eliminar"
                >
                  <i-lucide [img]="TrashIcon" class="lucide-icon"></i-lucide>
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>

      <!-- Paginación (si es necesaria) -->
      <div class="pagination-container" *ngIf="totalPaginas > 1">
        <div class="pagination-info">
          Mostrando {{ (paginaActual - 1) * elementosPorPagina + 1 }} -
          {{ Math.min(paginaActual * elementosPorPagina, formularios.length) }}
          de {{ formularios.length }} formularios
        </div>
        <div class="pagination-controls">
          <button
            class="pagination-button"
            (click)="cambiarPagina(paginaActual - 1)"
            [disabled]="paginaActual === 1"
          >
            <i-lucide [img]="ChevronLeftIcon" class="lucide-icon"></i-lucide>
            Anterior
          </button>
          <button
            class="pagination-button"
            (click)="cambiarPagina(paginaActual + 1)"
            [disabled]="paginaActual === totalPaginas"
          >
            Siguiente
            <i-lucide [img]="ChevronRightIcon" class="lucide-icon"></i-lucide>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal para crear/editar formulario -->
<p-dialog
  [(visible)]="mostrarModal"
  [modal]="true"
  [closable]="true"
  [draggable]="false"
  [resizable]="false"
  styleClass="formulario-dialog"
  [style]="{ width: '600px', maxWidth: '90vw' }"
  [header]="modoEdicion ? 'Editar Formulario' : 'Crear Nuevo Formulario'"
>
  <div class="modal-content">
    <form
      [formGroup]="formularioForm"
      (ngSubmit)="guardarFormulario()"
      novalidate
    >
      <div class="form-field">
        <label for="nombre">Nombre del Formulario *</label>
        <div class="input-container">
          <input
            id="nombre"
            type="text"
            formControlName="nombre"
            placeholder="Ingrese el nombre del formulario"
            [class.error]="
              formularioForm.get('nombre')?.invalid &&
              formularioForm.get('nombre')?.touched
            "
            class="form-input"
          />
          <i-lucide
            [img]="FileTextIcon"
            class="input-icon lucide-icon"
          ></i-lucide>
        </div>
        <div
          *ngIf="
            formularioForm.get('nombre')?.invalid &&
            formularioForm.get('nombre')?.touched
          "
          class="error-message"
        >
          <i-lucide [img]="AlertCircleIcon" class="lucide-icon"></i-lucide>
          {{ getErrorMessage("nombre") }}
        </div>
      </div>

      <div class="form-field">
        <label for="descripcion">Descripción</label>
        <div class="input-container">
          <textarea
            id="descripcion"
            formControlName="descripcion"
            placeholder="Descripción del formulario (opcional)"
            rows="4"
            class="form-textarea"
          ></textarea>
          <i-lucide
            [img]="AlignLeftIcon"
            class="input-icon lucide-icon"
          ></i-lucide>
        </div>
      </div>

      <div class="form-field">
        <label for="tipo_documento">Tipo de Documento *</label>
        <div class="input-container">
          <input
            id="tipo_documento"
            type="number"
            formControlName="tipo_documento"
            placeholder="ID del tipo de documento"
            [class.error]="
              formularioForm.get('tipo_documento')?.invalid &&
              formularioForm.get('tipo_documento')?.touched
            "
            class="form-input"
            min="1"
          />
          <i-lucide [img]="TagIcon" class="input-icon lucide-icon"></i-lucide>
        </div>
        <div
          *ngIf="
            formularioForm.get('tipo_documento')?.invalid &&
            formularioForm.get('tipo_documento')?.touched
          "
          class="error-message"
        >
          <i-lucide [img]="AlertCircleIcon" class="lucide-icon"></i-lucide>
          {{ getErrorMessage("tipo_documento") }}
        </div>
      </div>
    </form>
  </div>

  <ng-template pTemplate="footer">
    <div class="modal-actions">
      <button
        type="button"
        class="modal-button cancel"
        (click)="cerrarModal()"
        [disabled]="guardando"
      >
        <i-lucide [img]="XIcon" class="lucide-icon"></i-lucide>
        Cancelar
      </button>
      <button
        type="button"
        class="modal-button confirm"
        (click)="guardarFormulario()"
        [disabled]="formularioForm.invalid || guardando"
      >
        <div *ngIf="guardando" class="loading-state">
          <i-lucide
            [img]="LoaderIcon"
            class="loading-spinner lucide-icon"
          ></i-lucide>
          {{ modoEdicion ? "Actualizando..." : "Creando..." }}
        </div>
        <div
          *ngIf="!guardando"
          style="display: flex; align-items: center; gap: 8px"
        >
          <i-lucide [img]="SaveIcon" class="lucide-icon"></i-lucide>
          {{ modoEdicion ? "Actualizar" : "Crear" }} Formulario
        </div>
      </button>
    </div>
  </ng-template>
</p-dialog>

<!-- Modal de confirmación para eliminar -->
<p-confirmDialog
  [style]="{ width: '450px' }"
  [baseZIndex]="10000"
  rejectButtonStyleClass="p-button-text"
  acceptButtonStyleClass="p-button-danger"
>
</p-confirmDialog>

<!-- Toast para notificaciones -->
<p-toast position="top-right" [life]="5000"></p-toast>

<router-outlet></router-outlet>
